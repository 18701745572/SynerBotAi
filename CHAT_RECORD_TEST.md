# 🧪 聊天记录功能测试指南

## 测试目标
验证聊天记录功能是否正确保存和加载会话消息。

## 测试步骤

### 1. 基本功能测试

#### 1.1 创建新会话
1. 打开应用
2. 点击左侧的 "+ 新建聊天" 按钮
3. **预期结果**：应该创建一个新的会话，显示在左侧列表中

#### 1.2 发送消息并验证保存
1. 在新建的会话中输入消息（例如："你好"）
2. 发送消息并等待AI回复
3. 刷新浏览器页面
4. **预期结果**：
   - 消息应该被保存
   - 刷新后消息应该仍然存在
   - 会话标题应该更新为第一条用户消息的前20个字符

#### 1.3 多会话管理
1. 创建多个会话
2. 在每个会话中发送不同的消息
3. 在会话间切换
4. **预期结果**：
   - 每个会话的消息应该独立保存
   - 切换会话时应该显示对应的消息
   - 会话预览应该显示最后一条消息的前30个字符

### 2. 高级功能测试

#### 2.1 会话删除
1. 创建多个会话
2. 点击某个会话的删除按钮（🗑️）
3. **预期结果**：
   - 会话应该被删除
   - 如果删除的是当前会话，应该自动切换到其他会话
   - 如果没有其他会话，应该创建新会话

#### 2.2 会话标题和预览更新
1. 发送一条长消息（超过20个字符）
2. 等待AI回复
3. **预期结果**：
   - 会话标题应该显示用户消息的前20个字符 + "..."
   - 会话预览应该显示AI回复的前30个字符 + "..."

#### 2.3 本地存储测试
1. 发送一些消息
2. 关闭浏览器
3. 重新打开应用
4. **预期结果**：所有会话和消息应该被正确恢复

### 3. 错误处理测试

#### 3.1 网络错误处理
1. 关闭LM Studio
2. 尝试发送消息
3. **预期结果**：
   - 应该显示错误消息
   - 错误消息也应该被保存到会话中

#### 3.2 数据损坏处理
1. 手动修改localStorage中的chatSessions数据
2. 刷新页面
3. **预期结果**：应用应该能够处理损坏的数据并创建新会话

## 调试信息

### 检查本地存储
在浏览器开发者工具中：
1. 打开 Console 标签页
2. 输入：`localStorage.getItem('chatSessions')`
3. 查看返回的JSON数据

### 检查控制台日志
查看浏览器控制台是否有以下日志：
- "加载会话失败" - 表示会话加载有问题
- "选择会话: [sessionId]" - 表示会话切换正常
- "新建聊天: [sessionData]" - 表示新会话创建正常

## 常见问题排查

### 问题1：消息没有保存
**可能原因**：
- `saveCurrentSessionMessages` 函数没有正确调用
- localStorage 权限问题
- 会话ID不匹配

**解决方法**：
1. 检查浏览器控制台是否有错误
2. 确认localStorage是否可用
3. 验证会话ID是否正确

### 问题2：切换会话时消息不显示
**可能原因**：
- `loadSessionMessages` 函数没有正确执行
- 会话数据格式不正确
- 消息数组为空

**解决方法**：
1. 检查 `loadSessionMessages` 函数是否正确调用
2. 验证会话数据格式
3. 确认消息是否正确保存

### 问题3：会话标题不更新
**可能原因**：
- 消息格式不正确
- 标题更新逻辑有误
- 保存时机不对

**解决方法**：
1. 检查消息对象格式
2. 验证标题更新逻辑
3. 确认保存时机

## 测试完成标准

✅ **基本功能正常**：
- 能够创建新会话
- 消息能够正确保存
- 会话间切换正常

✅ **数据持久化正常**：
- 刷新页面后数据不丢失
- 关闭浏览器后数据不丢失

✅ **用户体验良好**：
- 会话标题和预览正确更新
- 删除功能正常工作
- 错误处理完善

## 修复后的主要改进

1. **消息与会话集成**：消息现在正确保存到对应的会话中
2. **会话状态管理**：会话的创建、选择、删除都有完整的状态管理
3. **数据持久化**：所有会话数据都保存到localStorage
4. **自动标题更新**：会话标题和预览会根据消息内容自动更新
5. **错误处理**：完善的错误处理和状态恢复机制

如果测试中发现任何问题，请检查浏览器控制台的错误信息，这将帮助快速定位问题所在。
